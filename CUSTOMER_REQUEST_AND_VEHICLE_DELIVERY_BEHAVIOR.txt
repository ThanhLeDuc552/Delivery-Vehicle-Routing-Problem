================================================================================
CUSTOMER REQUEST BEHAVIOR AND VEHICLE DELIVERY BEHAVIOR
================================================================================

This document describes the current implementation of:
1. Customer Request Behavior (RequestGeneratorBehaviour and ResponseHandlerBehaviour)
2. Vehicle Delivery Behavior (RouteCompletionBehaviour and notifyDepotWinner)

================================================================================
1. CUSTOMER REQUEST BEHAVIOR
================================================================================

1.1 REQUEST GENERATOR BEHAVIOUR (RequestGeneratorBehaviour)
------------------------------------------------------------
Location: src/main/java/project/Agent/Customer.java (Lines 73-116)

Type: TickerBehaviour (periodic behavior)

Initial Period: 5000 + random.nextInt(10000) milliseconds (5-15 seconds)
Subsequent Period: 30000 + random.nextInt(30000) milliseconds (30-60 seconds)

Behavior:
---------
1. On each tick:
   - Generates a random item request:
     * Item: Randomly selected from {"ItemA", "ItemB", "ItemC", "ItemD"}
     * Quantity: Random between 5-15 units (5 + random.nextInt(10))
   
   - Creates CustomerRequest object with:
     * customerId
     * customerName
     * x, y coordinates
     * itemName
     * quantity

2. Finds Depot via DF (Directory Facilitator):
   - Searches for "depot-service" type
   - If depot not found, logs error and returns

3. Sends FIPA-REQUEST message to Depot:
   - Performative: REQUEST
   - Protocol: fipa-request
   - Conversation ID: "req-" + request.requestId
   - Reply With: "rw-" + System.currentTimeMillis()
   - Content Format: "REQUEST:customerId|customerName|x|y|itemName|quantity"
   
   Example: "REQUEST:customer-1|Customer1|100.00|150.00|ItemA|5"

4. Logs the request:
   - Logs sent message
   - Logs event: "Sent request: {quantity} units of {itemName}"
   - Prints to console

5. Resets period for next request (30-60 seconds)


1.2 RESPONSE HANDLER BEHAVIOUR (ResponseHandlerBehaviour)
----------------------------------------------------------
Location: src/main/java/project/Agent/Customer.java (Lines 121-152)

Type: CyclicBehaviour (continuous behavior)

Behavior:
---------
1. Continuously listens for messages from Depot

2. When message received:
   - Logs received message
   - Parses message content

3. Handles different message types:

   a) INFORM messages:
      - "ITEM_AVAILABLE:..." 
        → Logs: "Request accepted: {message}"
        → Prints: "✓ Request accepted - {message}"
      
      - "ITEM_UNAVAILABLE:..."
        → Logs: "Request rejected: {message}"
        → Prints: "✗ Request rejected - {message}"
      
      - "ROUTE_ASSIGNED:..."
        → Logs: "Route assigned: {message}"
        → Prints: "Route assigned - {message}"
      
      - "DELIVERY_COMPLETE:..."
        → Logs: "DELIVERY COMPLETE: {message}"
        → Prints: "✓✓✓ DELIVERY COMPLETE - {message}"

   b) REFUSE messages:
      → Logs: "Request refused: {content}"
      → Prints: "Request was refused - {content}"

4. Blocks if no message received (waits for next message)


================================================================================
2. VEHICLE DELIVERY BEHAVIOR
================================================================================

2.1 ROUTE ASSIGNMENT (notifyDepotWinner)
----------------------------------------
Location: src/main/java/project/Agent/VehicleAgent.java (Lines 480-505)

Trigger: When vehicle wins route in vehicle-to-vehicle bidding

Behavior:
---------
1. Finds Depot via DF:
   - Searches for "depot-service" type
   - If not found, logs error and returns

2. Sends winner notification to Depot:
   - Performative: INFORM
   - Protocol: fipa-request
   - Content Format: "ROUTE_WON:ROUTE:{routeId}|VEHICLE:{vehicleName}|{routeData}"
   
   Example: "ROUTE_WON:ROUTE:1|VEHICLE:Vehicle1|ROUTE:1|CUSTOMERS:1,2,3|CUSTOMER_IDS:customer-1,customer-2,customer-3|COORDS:...|..."

3. Parses route data and starts movement:
   - Calls parseRouteAndStartMovement(routeId, routeData)
   - Updates vehicle state: assignedRouteId = routeId, state = "absent"
   - Extracts customer information from route data
   - Starts MovementBehaviour for real movement simulation


2.2 ROUTE PARSING (parseRouteAndStartMovement)
-----------------------------------------------
Location: src/main/java/project/Agent/VehicleAgent.java (Lines 507-584)

Trigger: Called by notifyDepotWinner after winning route

Behavior:
---------
1. Parses route data:
   - Format: "ROUTE:routeId|CUSTOMERS:numericId1,numericId2|CUSTOMER_IDS:customer-1,customer-2|COORDS:x1,y1;x2,y2|DEMAND:total|DISTANCE:total"
   - Extracts numeric customer IDs (from solver)
   - Extracts actual customer agent IDs (customer-1, customer-2, etc.)
   - Extracts customer coordinates

2. Creates CustomerInfo list:
   - Creates CustomerInfo object for each customer on route
   - Stores customer coordinates, numeric ID, and agent ID
   - Stores route in currentRoute

3. Initializes movement state:
   - currentCustomerIndex = 0 (first customer)
   - isMoving = true
   - Sets target to first customer coordinates

4. Starts MovementBehaviour:
   - Adds MovementBehaviour with 1000ms period (1 second updates)
   - Movement starts immediately toward first customer


2.3 MOVEMENT BEHAVIOUR (MovementBehaviour)
------------------------------------------
Location: src/main/java/project/Agent/VehicleAgent.java (Lines 895-1111)

Type: TickerBehaviour (periodic behavior, updates every second)

Period: 1000 milliseconds (1 second)

Movement Speed: 10.0 units per second
Arrival Threshold: 1.0 unit distance

Behavior (onTick - every second):
---------------------------------
1. Movement State Check:
   - Only processes if isMoving = true
   - Checks if moving to customer or returning to depot

2. Moving to Customer (moveTowardsCustomer):
   a) Gets current target customer from currentRoute
   b) Calculates distance to target customer
   c) If distance <= ARRIVAL_THRESHOLD (1.0 unit):
      - Sets vehicle position to customer location (exact)
      - Calls notifyCustomerArrival(customer)
      - Moves to next customer in route
      - If no more customers, sets currentCustomerIndex = -2 (return to depot)
   d) If distance > ARRIVAL_THRESHOLD:
      - Moves 10 units toward target (or remaining distance if less)
      - Updates currentX and currentY using linear interpolation
      - Logs position every 5 seconds

3. Returning to Depot (returnToDepot):
   a) Sets target to depot coordinates (0, 0)
   b) Calculates distance to depot
   c) If distance <= ARRIVAL_THRESHOLD:
      - Sets vehicle position to depot (exact)
      - Sets isMoving = false
      - Sets state = "free"
      - Clears assignedRouteId and currentRoute
      - Stops MovementBehaviour
   d) If distance > ARRIVAL_THRESHOLD:
      - Moves 10 units toward depot
      - Updates currentX and currentY
      - Logs position every 5 seconds


2.4 CUSTOMER DELIVERY NOTIFICATION (notifyCustomerArrival)
----------------------------------------------------------
Location: src/main/java/project/Agent/VehicleAgent.java (Lines 1034-1111)

Trigger: Called by MovementBehaviour when vehicle arrives at customer location

Behavior:
---------
1. Finds customer via DF:
   - Searches for "customer-service" type
   - Matches customer using customer.name (contains actual customer agent ID)
   - Customer agent IDs format: "customer-1", "customer-2", etc.

2. Sends delivery notification:
   - Performative: INFORM
   - Protocol: fipa-request
   - Conversation ID: "delivery-" + System.currentTimeMillis()
   - Content: "DELIVERY_COMPLETE:Your order has been delivered by vehicle {vehicleName}. Package arrived at ({x}, {y})"
   
   Example: "DELIVERY_COMPLETE:Your order has been delivered by vehicle Vehicle1. Package arrived at (100.00, 150.00)"

3. Logs:
   - Logs sent message
   - Prints: "Notified customer {customerName} (ID: {customerId}) about delivery completion"
   - If customer not found: Prints warning and lists available customers

4. Error handling:
   - Catches FIPAException if DF search fails
   - Logs error message

5. Timing:
   - Notification is sent ONLY when vehicle actually arrives at customer location
   - Customers are notified in route order (one at a time)
   - Each customer receives notification when vehicle reaches their location


================================================================================
3. MOVEMENT SIMULATION DETAILS
================================================================================

3.1 Real Movement Implementation:
---------------------------------
- Vehicle position is updated every second during route execution
- Vehicles move at 10 units per second toward customers
- Movement is calculated using linear interpolation
- Position updates are logged every 5 seconds during movement
- Vehicles visit customers one by one in route order

3.2 Route Execution:
--------------------
- Route execution time is calculated based on actual distance
- Travel time = distance / movement speed (10 units/second)
- Vehicles visit customers sequentially (not simultaneously)
- Position is tracked continuously during entire route
- Vehicles start at depot (0, 0) when system starts

3.3 Customer Request Timing:
----------------------------
- First request: 5-15 seconds after customer agent starts
- Subsequent requests: 30-60 seconds apart
- Requests are independent (no coordination between customers)

3.4 Delivery Notification:
--------------------------
- Customers are notified individually when vehicle arrives at their location
- Notification happens only when vehicle reaches customer (within 1 unit threshold)
- Customers are notified in route order (one at a time)
- Each customer receives notification with actual arrival coordinates
- Notification includes vehicle name and arrival location

3.5 Movement Parameters:
------------------------
- Movement Speed: 10.0 units per second
- Update Frequency: 1000 milliseconds (1 second)
- Arrival Threshold: 1.0 unit distance
- Starting Position: Depot (0, 0) for all vehicles
- Movement Calculation: Linear interpolation toward target


================================================================================
4. MESSAGE FLOW SUMMARY
================================================================================

Customer Request Flow:
---------------------
1. Customer → Depot: REQUEST (item, quantity, location)
2. Depot → Customer: INFORM (ITEM_AVAILABLE or ITEM_UNAVAILABLE)
3. [Depot processes batch, solves VRP, announces routes]
4. [Vehicles bid among themselves]
5. Winner Vehicle → Depot: INFORM (ROUTE_WON)
6. [Vehicle executes route with real movement]
   - Vehicle moves toward first customer (10 units/second)
   - Vehicle arrives at customer → Notifies customer
   - Vehicle moves to next customer → Notifies customer
   - Repeat for all customers in route
   - Vehicle returns to depot
7. Vehicle → Customer: INFORM (DELIVERY_COMPLETE) when arrived
8. Customer receives: DELIVERY_COMPLETE notification with arrival coordinates

Vehicle Delivery Flow:
---------------------
1. Vehicle wins route in bidding
2. Vehicle notifies depot (ROUTE_WON)
3. Vehicle state changes to "absent"
4. Vehicle parses route data and extracts customer information
5. MovementBehaviour starts (updates every 1 second)
6. Vehicle moves toward first customer (10 units/second):
   - Position updated every second
   - Distance calculated and movement interpolated
   - Logs position every 5 seconds
7. When vehicle arrives at customer (within 1 unit):
   - Vehicle notifies customer (DELIVERY_COMPLETE)
   - Vehicle moves to next customer in route
8. After all customers visited:
   - Vehicle returns to depot (10 units/second)
   - Position updated every second during return
9. When vehicle arrives at depot:
   - Vehicle state changes to "free"
   - Vehicle position set to depot (0, 0) exactly
   - MovementBehaviour stops
   - Vehicle is ready for next route


================================================================================
END OF DOCUMENT
================================================================================


