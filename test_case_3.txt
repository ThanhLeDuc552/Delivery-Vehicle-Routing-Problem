~Test case 3: Flexible VRP with Pickup & Delivery, Cross-Docks, and Consolidation (Multi-Agent)

1) Goal and Scope (enhanced from TC2)
- Extend TC2 (inventory + batching + FIPA Depot↔Delivery) to support:
  - Pickup & Delivery requests (P&D)
  - Multiple depots and cross-docks (transfer points)
  - Consolidations (combine shipments at cross-docks)
  - Heterogeneous vehicles, open routes
  - Time windows (customers and vehicles)
- Start heuristic-first (Google OR-Tools baseline + simple consolidation rules), leave TSAM-like metaheuristic for later.

2) Agents and Responsibilities
- CoordinatorAgent (new):
  - Global orchestration; assigns requests to depots/cross-docks, selects consolidation opportunities.
  - Maintains global topology (depots, cross-docks), SLAs, and policies.
  - Protocols: FIPA-REQUEST to Depot/CrossDock; CONTRACT-NET for multi-depot bidding (optional phase 2).
- DepotAgent (extend existing Depot):
  - Now supports pickups, deliveries, and cross-dock interactions.
  - Maintains local inventory/staging; batches local requests; solves subproblems with available vehicles.
  - Communicates with DeliveryAgent and CrossDockAgents.
- CrossDockAgent (new):
  - Acts as a transshipment point; receives partial loads, consolidates by destination region, re-issues sub-requests.
  - Maintains transient inventory (short dwell time), emits consolidation events.
- DeliveryAgent (extend existing):
  - Manages heterogeneous VehicleAgents; queries states; runs Contract-Net for route assignment (phase 2).
- VehicleAgent (extend existing):
  - Heterogeneous attributes (capacity, speed, compatibilities); state machine: free/absent/busy.
  - In phase 2: participate in Contract-Net to bid for legs (consider time window feasibility and capacity slack).
- CustomerAgent (new/mock or real):
  - Emits P&D requests (pickup location, delivery location, time window, load type/size).
- EventBusAgent (new, optional):
  - Collects and broadcasts system events for UI/monitoring.

3) Interaction Protocols
- Coordinator → Depot/CrossDock: FIPA-REQUEST (assign or query capacity/ETA)
- Depot ↔ Delivery: FIPA-REQUEST (already in TC2)
- Delivery ↔ Vehicles: CONTRACT-NET (phase 2) or REQUEST/CONFIRM (phase 1)
- Depot ↔ CrossDock: FIPA-REQUEST (schedule transfer windows, announce inbound consignments)
- CrossDock → Coordinator: INFORM (consolidation opportunities, dwell threshold alerts)
- All flows carry conversationId; MessageTemplate filters by protocol and conversation.

4) Data Model (incremental over TC2)
- Request (P&D):
  {
    id: string,
    pickup: { x: number, y: number, tw: [start,end] },
    delivery: { x: number, y: number, tw: [start,end] },
    demand: number,
    itemType?: string,
    priority?: number
  }
- Vehicle:
  { name: string, capacity: number, speed?: number, compat?: string[] }
- Cross-dock:
  { name: string, x: number, y: number, dwellLimitMin?: number }
- Consolidation plan (internal):
  { clusterId: string, hub: crossDockName, requests: string[], targetRegion?: string }

5) High-Level Workflow
1. CustomerAgents emit P&D requests; Coordinator ingests them.
2. Coordinator clusters requests (by region/time compatibility) and decides:
   - Direct shipping; or via cross-dock (consolidate).
3. Coordinator issues FIPA-REQUEST to target Depot(s)/CrossDock(s) with assigned sub-batches.
4. Depot checks available vehicles via Delivery (FIPA-REQUEST → NAMES) and solves local subproblem with OR-Tools (VRP with pickups, deliveries, and precedence + capacity + time windows if enabled).
5. CrossDock receives partial inbound legs, holds short dwell, triggers outbound consolidation legs.
6. Delivery assigns legs to VehicleAgents (phase 1: direct assignment; phase 2: Contract-Net bidding on legs).
7. Delivery reports events and final composed routes to Backend API.
8. UI shows multi-leg routes, consolidations, and cross-dock activities.

6) Solver Strategy (baseline)
- Phase 1: OR-Tools VRP with PickupsDeliveries + Capacity; optional Time Windows with slack.
- Decompose by depot/cross-dock legs: inbound (pickups→hub), outbound (hub→deliveries).
- Use simple rules for consolidation (cluster by k-means on coordinates + TW overlap window).
- Metrics: total_distance, late_penalties (if enabled), number of transfers, vehicle utilization.

7) Acceptance Criteria
- Support P&D requests with precedence (pickup before delivery) and capacity feasibility.
- Execute at least one flow with cross-dock consolidation (inbound legs converge to CrossDock, outbound legs depart to deliveries).
- Vehicle heterogeneity respected (capacity and optional compatibility).
- Events include: consolidation created, leg assigned, cross-dock dwell start/end, handoff complete.
- API response composes multi-leg routes per vehicle with route_id and leg metadata.

8) API Extensions (compatible with current)
- Extend routes with legs array when cross-docks used:
  routes: [
    {
      route_id: "R1",
      vehicle_agent: "Truck-A",
      legs: [
        {
          leg_id: "L1",
          type: "inbound",
          from: { x, y, name?: string },
          to: { x, y, name?: string },
          stops: CustomerOnRoute[],
          total_distance,
          cross_dock?: "CD-1"
        },
        {
          leg_id: "L2",
          type: "outbound",
          from: { x, y, name?: string },
          to: { x, y, name?: string },
          stops: CustomerOnRoute[],
          total_distance,
          cross_dock?: "CD-1"
        }
      ],
      total_demand,
      total_distance
    }
  ]
- Backward compatibility: if legs absent, treat entire route as single-leg (TC1/TC2 behavior).

9) Frontend Additions
- New overlays for cross-docks and leg visualization (color-coded inbound/outbound).
- Consolidation panel: shows cluster members, hub, and timing.
- Event stream: consolidation created, leg handoff at hub, dwell complete, late risk alerts.

10) Implementation Plan (phased)
- Phase A (Minimal viable):
  - Add CoordinatorAgent, CrossDockAgent skeletons.
  - Extend Depot to accept P&D and call OR-Tools with pickups-deliveries for a single depot (no time windows).
  - Keep Delivery assignment simple; no Contract-Net yet.
- Phase B (Consolidation):
  - Add simple clustering → create inbound/outbound legs via one CrossDockAgent.
  - Extend API/Frontend to render legs.
- Phase C (Time Windows + Multi-Depot):
  - Enable TW in solver; add multiple depots; Coordinator splits batches among depots.
- Phase D (Contract-Net on legs):
  - Delivery runs CN protocol, VehicleAgents bid with feasibility + cost; select winners per leg.

11) Concrete Changes (code touchpoints)
- Java/JADE:
  - New: `project.Agent.Coordinator`, `project.Agent.CrossDock` (+ messages/behaviours).
  - Extend `Depot` to parse P&D, generate pickups-deliveries constraints, support leg packaging.
  - Extend `Delivery` to accept legs and (later) CN bidding; keep FIPA metadata.
  - Extend `VehicleAgent` with attributes (speed, compat) + feasibility checks.
- Backend (Python):
  - Accept extended response schema (`legs` optional).
  - Add /api/topology (optional) to provide depots/cross-docks map to UI.
- Frontend (TS):
  - Update types to include optional `legs` and cross-dock visuals.
  - Add panels for consolidation and events.

12) Sample Message Flows
- Coordinator → Depot (assign sub-batch): FIPA-REQUEST content: ASSIGN_BATCH:{...}
- Depot → Delivery (query vehicles): FIPA-REQUEST content: VEHICLES:name:cap,... (as TC2)
- Delivery → Depot (names): INFORM content: NAMES:...
- Depot → Delivery (routes with legs or flat routes): INFORM content: ROUTES:...|ROUTE_DATA:JSON
- Delivery → API: POST /api/solve-cvrp?action=response body: extended JSON (with optional legs)

13) Risks and Mitigations
- Complexity explosion: stage features (A→D), keep JSON backward compatible.
- Synchronization at cross-docks: start with deterministic dwell rules (e.g., release every T seconds or min group size).
- Contract-Net overhead: enable only in Phase D and on leg granularity.
